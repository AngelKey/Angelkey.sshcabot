version: '3'
services:
  ca-bot:
    build:
      context: ../
      dockerfile: "docker/Dockerfile-ca"
    environment:
      - PAPERKEY=${BOT_PAPERKEY}
      - KEYBASE_USERNAME=${BOT_USERNAME}
    volumes:
      - app-volume:/mnt/
    user: root
    command: "sh -c 'chown keybase:keybase /mnt && su keybase -c \"bash tests/bot-entrypoint.sh\"'"
  kssh:
    build:
      context: ../
      dockerfile: "docker/Dockerfile-ca"
    environment:
      - PAPERKEY=${KSSH_PAPERKEY}
      - KEYBASE_USERNAME=${KSSH_USERNAME}
      - SUBTEAM=${SUBTEAM}
      - SUBTEAM_SECONDARY=${SUBTEAM_SECONDARY}
    volumes:
      - app-volume:/mnt/
    user: keybase
    command: "bash tests/kssh-entrypoint.sh"
    depends_on:
      - sshd
      - ca-bot
  sshd:
    build:
      context: .
      dockerfile: Dockerfile-sshd
    volumes:
      - app-volume:/mnt/
    depends_on:
      - ca-bot
volumes:
  app-volume:
