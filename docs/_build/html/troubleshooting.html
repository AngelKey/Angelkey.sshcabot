

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Troubleshooting &mdash; Keybase SSH CA Bot  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Keybase SSH CA Bot
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">Troubleshooting</a><ul>
<li><a class="reference internal" href="#kssh-is-slow-but-it-works">kssh is slow, but it works</a></li>
<li><a class="reference internal" href="#kssh-times-out">kssh times out</a></li>
<li><a class="reference internal" href="#ssh-rejects-the-connection">SSH rejects the connection</a></li>
<li><a class="reference internal" href="#keybase-is-down">Keybase is down</a></li>
<li><a class="reference internal" href="#default-users-and-kssh-provision">Default Users and kssh –provision</a></li>
</ul>
</li>
</ul>
</div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Keybase SSH CA Bot</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Troubleshooting</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/troubleshooting.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="troubleshooting">
<h1>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this headline">¶</a></h1>
<p>This file contains some general directions and thoughts on troubleshooting the code in this repo. This is not meant
to be a comprehensive troubleshooting guide and is only a jumping off point.</p>
<div class="section" id="kssh-is-slow-but-it-works">
<h2>kssh is slow, but it works<a class="headerlink" href="#kssh-is-slow-but-it-works" title="Permalink to this headline">¶</a></h2>
<p>When kssh starts, it has to search every team you are in for a <code class="docutils literal notranslate"><span class="pre">kssh-client.config</span></code> file which specifies the information
that is needed in order to communicate with the CA chatbot. If you are only in a few teams, this is relatively fast
(1-2 seconds for &lt;10 teams) but this can become much slower as the number of teams increases (6 seconds for 100 teams
in my benchmarks). This complex start up procedure can be avoided by setting a default bot via
<code class="docutils literal notranslate"><span class="pre">kssh</span> <span class="pre">--set-default-bot</span> <span class="pre">cabotname</span></code> which should reduce kssh’s startup time considerably.</p>
</div>
<div class="section" id="kssh-times-out">
<h2>kssh times out<a class="headerlink" href="#kssh-times-out" title="Permalink to this headline">¶</a></h2>
<p>If kssh times out with a message similar to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Generating</span> <span class="n">a</span> <span class="n">new</span> <span class="n">SSH</span> <span class="n">key</span><span class="o">...</span>
<span class="n">Requesting</span> <span class="n">signature</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">CA</span><span class="o">....</span>
<span class="n">Failed</span> <span class="n">to</span> <span class="n">get</span> <span class="n">a</span> <span class="n">signed</span> <span class="n">key</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">CA</span><span class="p">:</span> <span class="n">timed</span> <span class="n">out</span> <span class="k">while</span> <span class="n">waiting</span> <span class="k">for</span> <span class="n">a</span> <span class="n">response</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">CA</span>
</pre></div>
</div>
<p>It means that for whatever reason, kssh is not receiving a response from the CA chatbot when it sends messages in
Keybase chat. First, ensure that the CA chatbot is currently running. Next, attempt to determine what is happening
by inspecting the chat messages inside of the teams configured with the chatbot. You should see a series of <code class="docutils literal notranslate"><span class="pre">Ack</span></code> and
<code class="docutils literal notranslate"><span class="pre">AckRequest</span></code> messages going back and forth prior to a <code class="docutils literal notranslate"><span class="pre">Signature_Request:</span></code> and a <code class="docutils literal notranslate"><span class="pre">Signature_Response:</span></code> exchange. Ensure
that you and the chatbot are in the correct teams such that they can read and respond to the messages.</p>
</div>
<div class="section" id="ssh-rejects-the-connection">
<h2>SSH rejects the connection<a class="headerlink" href="#ssh-rejects-the-connection" title="Permalink to this headline">¶</a></h2>
<p>This likely means that you have not configured the SSH server correctly. Review the directions in README.md and ensure
that you have followed the steps correctly (<a class="reference internal" href="sshca.html"><span class="doc">sshca.md</span></a> also has some additional information on how SSH CAs work that may
be helpful). If you would like to follow an example, see the code in the <code class="docutils literal notranslate"><span class="pre">tests/</span></code> directory which contains integration
tests (focus on Dockerfile-sshd for an example SSH server setup). If none of that works, the best strategy is to run
SSH on the server on an alternate port and review the debug information. On the server run <code class="docutils literal notranslate"><span class="pre">/usr/sbin/sshd</span> <span class="pre">-dd</span> <span class="pre">-D</span> <span class="pre">-p</span> <span class="pre">2222</span></code>
and on the client run <code class="docutils literal notranslate"><span class="pre">kssh</span> <span class="pre">-p</span> <span class="pre">2222</span> <span class="pre">user&#64;server</span></code> and inspect the debug logs.</p>
</div>
<div class="section" id="keybase-is-down">
<h2>Keybase is down<a class="headerlink" href="#keybase-is-down" title="Permalink to this headline">¶</a></h2>
<p>If Keybase is down, the bot will not work since it relies on Keybase chat for communication. In this scenario, you can
manually sign SSH keys with the CA key. This can be done via <code class="docutils literal notranslate"><span class="pre">keybaseca</span> <span class="pre">sign</span> <span class="pre">--public-key</span> <span class="pre">/path/to/key.pub</span></code>. Alternatively,
this can be done manually without relying on any of the tooling in this repository. To do so, place the CA private key
in <code class="docutils literal notranslate"><span class="pre">~/cakey</span></code> and the CA public key in <code class="docutils literal notranslate"><span class="pre">~/cakey.pub</span></code>. Then run the command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ssh-keygen <span class="se">\</span>
  <span class="c1"># The location of the ca key:</span>
  -s ~/cakey  <span class="se">\</span>
  <span class="c1"># A unique ID for each key. Used to audit key usage</span>
  -I unique-key-id <span class="se">\</span>
  <span class="c1"># The comma separated list of principals you wish to sign the key for. Eg &quot;team.ssh.prod,team.ssh.staging,team.ssh.root_everywhere&quot;</span>
  -n <span class="s2">&quot;team.ssh.prod,team.ssh.staging,team.ssh.root_everywhere&quot;</span> <span class="se">\</span>
  <span class="c1"># How long the signature is valid for. +1d means one day. Valid units are `h` for hour, `d` for day, `w` for week</span>
  -V +1d <span class="se">\</span>
  <span class="c1"># Specify the password on the CA key (if exported via `keybaseca backup` there is no password)</span>
  -N <span class="s2">&quot;&quot;</span> <span class="se">\</span>
  <span class="c1"># The location of the public key you wish to sign</span>
  /path/to/key.pub
</pre></div>
</div>
<p>You can then use the signed SSH key to SSH via <code class="docutils literal notranslate"><span class="pre">ssh</span> <span class="pre">-i</span> <span class="pre">/path/to/key.pub</span> <span class="pre">user&#64;server</span></code>.</p>
</div>
<div class="section" id="default-users-and-kssh-provision">
<h2>Default Users and kssh –provision<a class="headerlink" href="#default-users-and-kssh-provision" title="Permalink to this headline">¶</a></h2>
<p>Default users are implemented using a custom SSH config file that inherits from the default one. This means that if you
run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kssh --set-default-user developer
kssh --provision
scp foo server:~/
</pre></div>
</div>
<p>It will not use the default user. There are two ways to work around this. If you do not need the default user to be kssh
specific (eg if kssh is your primary way of accessing certain servers), then you can simply configure this default user
globally by adding the below lines to <code class="docutils literal notranslate"><span class="pre">~/.ssh/config</span></code></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Host *
  User developer
</pre></div>
</div>
<p>If you do not want to do this, you can run scp with the kssh specific config file via:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>scp -F ~/.ssh/kssh-config foo server:~/
</pre></div>
</div>
<p>Or analogously for rsync:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>rsync -e <span class="s2">&quot;ssh -F </span><span class="nv">$HOME</span><span class="s2">/.ssh/kssh-config&quot;</span> foo server:~/
</pre></div>
</div>
<p>It may be useful to define aliases in your bashrc to simplify this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">alias</span> <span class="nv">kscp</span><span class="o">=</span><span class="s1">&#39;kssh --provision &amp;&amp; scp -F ~/.ssh/kssh-config&#39;</span>
<span class="nb">alias</span> <span class="nv">krsync</span><span class="o">=</span><span class="s1">&#39;kssh --provision &amp;&amp; rsync -e &quot;ssh -F $HOME/.ssh/kssh-config&quot;&#39;</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, keybase.io

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>